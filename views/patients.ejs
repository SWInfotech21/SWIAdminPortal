<!-- Wappler include head-page="layouts/main" is="dmx-app" id="patients" appConnect="local" -->
<meta name="ac:route" content="/patients">

<dmx-query-manager id="qm"></dmx-query-manager>
<dmx-json-datasource id="json_countries" is="dmx-serverconnect" url="/assets/json/countriesList.json"></dmx-json-datasource>
<dmx-serverconnect id="scPatients" url="/api/Patients/patientsList" dmx-param:limit="10" dmx-param:offset="qm.data.offset" dmx-param:sort="qm.data.sort" dmx-param:dir="qm.data.dir"></dmx-serverconnect>
<dmx-data-detail id="ddPatient" dmx-bind:data="scPatients.data.PatientsList.data" key="id"></dmx-data-detail>

<!-- <dmx-data-detail id="" dmx-bind:data="" key="id"></dmx-data-detail> -->
<div class="row align-items-center justify-content-between px-4 mb-3 sd-secondary-header mx-0">
    <div class="col-12 col-md-auto me-auto">
        <h1 class="ms-md-1 mt-md-3 text-dark fs-2 sd-fw-800 d-flex align-items-center">
            Patients List
            <span class="border-3 ms-2 spinner-border spinner-border-sm" role="status" dmx-show="scPatients.state.executing"></span>
        </h1>
    </div>
    <div class="col-auto order-2 order-md-1 d-flex align-items-center justify-content-start justify-content-md-center px-0 px-lg-2">
        <button id="btnFilter" class="btn" data-bs-toggle="modal" data-bs-target="#modalFilter" onclick="InitializePhoneInput('inpPhoneNr', 'lblCountry1', 'lblCountryCode1', 'FullPhone1')"><img src="/assets/images/icons/Filter.svg" alt="Filter" class="sd-icon-dimensions"></button>
    </div>
    <div class="col-auto order-1 order-md-3 d-flex align-items-center justify-content-center">
        <form id="formSearchUser" class="sd-search-form">
            <div class="d-flex justify-content-end mb-3 mb-lg-0 mb-md-0">
                <input type="text" class="form-control sd-search-input rounded-pill" id="Search" name="Search" placeholder="Search">
                <span class="bg-transparent btn position-absolute px-1 py-1"><img src="/assets/images/icons/Search.svg" alt="icon" class="sd-icon-dimensions mb-1 mb-xl-0"></span>
            </div>
        </form>
    </div>
    <div class="col-auto order-2 order-md-4 d-flex align-items-center justify-content-center">
        <button id="btnAddPatient" class="align-items-center btn btn-primary btn-rounded d-flex justify-content-center px-5 px-lg-5 px-md-3 py-1 sd-fs-14 sd-fw-600 text-white text-nowrap sd-vw-68" data-bs-toggle="modal" data-bs-target="#modalAddPatient" onclick="InitializePhoneInput('txtPhone', 'lblCountry', 'lblCountryCode', 'lblFullPhone')"><img src="/assets/images/icons/Plus.svg" alt="add" class="sd-icon-dimensions me-2">Add Patient</button>
    </div>
</div>

<div class="container-fluid px-4" id="PatientsList">
    <div class="table-responsive sd-table">
        <table class="table bg-white table-hover table-borderless">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Nationality</th>
                    <th>Date of birth</th>
                    <th>Phone</th>
                    <th>Email</th>
                </tr>
            </thead>
            <tbody is="dmx-repeat" dmx-generator="bs5paging" dmx-bind:repeat="scPatients.data.PatientsList.data" id="repeatPatientsList">
                <tr>
                    <td dmx-on:click="browser1.goto('patients-details/'+id,true)">{{id}}</td>
                    <td dmx-on:click="browser1.goto('patients-details/'+id,true)" dmx-text="firstname.titlecase()+' '+lastname.titlecase()"></td>
                    <td dmx-on:click="browser1.goto('patients-details/'+id,true)">
                        <img src="/assets/images/icons/Male.svg" class="sd-icon-dimensions" alt="Male" dmx-show="gender == 'Male'">
                        <img src="/assets/images/icons/Female.svg" class="sd-icon-dimensions" alt="Female" dmx-show="gender == 'Female'">{{gender}}
                    </td>
                    <td dmx-on:click="browser1.goto('patients-details/'+id,true)" dmx-text="nationality"></td>
                    <td dmx-on:click="browser1.goto('patients-details/'+id,true)" dmx-text="dateofbirth ? dateofbirth.formatDate('MMM dd, yyyy')+', '+ dateofbirth.yearsUntil(dateNow.datetime)+' y.o.' : ''">
                    </td>
                    <td><a dmx-bind:href="tel:{{countrycode}}{{phone}}">{{countrycode}} {{phone}}</a></td>
                    <td><a dmx-bind:href="mailto:'{{email}}'">{{email}}</a></td>
                </tr>
            </tbody>
        </table>
    </div>

    <ul class="pagination" dmx-populate="content.scPatients.data.PatientsList" dmx-state="qm" dmx-offset="offset" dmx-generator="bs5paging">
        <li class="page-item" dmx-class:disabled="content.scPatients.data.PatientsList.page.current == 1" aria-label="First">
            <a href="javascript:void(0)" class="page-link" dmx-on:click="qm.set('offset',content.scPatients.data.PatientsList.page.offset.first)"><span aria-hidden="true">&lsaquo;&lsaquo;</span></a>
        </li>
        <li class="page-item" dmx-class:disabled="content.scPatients.data.PatientsList.page.current == 1" aria-label="Previous">
            <a href="javascript:void(0)" class="page-link" dmx-on:click="qm.set('offset',content.scPatients.data.PatientsList.page.offset.prev)"><span aria-hidden="true">&lsaquo;</span></a>
        </li>
        <li class="page-item" dmx-class:active="title == content.scPatients.data.PatientsList.page.current" dmx-class:disabled="!active" dmx-repeat="content.scPatients.data.PatientsList.getServerConnectPagination(2,1,'...')">
            <a href="javascript:void(0)" class="page-link" dmx-on:click="qm.set('offset',(page-1)*content.scPatients.data.PatientsList.limit)">{{title}}</a>
        </li>
        <li class="page-item" dmx-class:disabled="content.scPatients.data.PatientsList.page.current ==  content.scPatients.data.PatientsList.page.total" aria-label="Next">
            <a href="javascript:void(0)" class="page-link" dmx-on:click="qm.set('offset',content.scPatients.data.PatientsList.page.offset.next)"><span aria-hidden="true">&rsaquo;</span></a>
        </li>
        <li class="page-item" dmx-class:disabled="content.scPatients.data.PatientsList.page.current ==  content.scPatients.data.PatientsList.page.total" aria-label="Last">
            <a href="javascript:void(0)" class="page-link" dmx-on:click="qm.set('offset',content.scPatients.data.PatientsList.page.offset.last)"><span aria-hidden="true">&rsaquo;&rsaquo;</span></a>
        </li>
    </ul>

</div>

<div class="modal fade fixed-left sd-right-sidebar-40" id="modalFilter" is="dmx-bs5-modal" tabindex="-1">
    <div class="modal-dialog modal-dialog-aside my-0 modal-lg" role="document">
        <div class="modal-content rounded-0 px-3">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="bg-transparent border-0 ms-auto p-0 px-1" data-bs-dismiss="modal" aria-label="Close">
                    <img src="/assets/images/icons/Close.svg" class="sd-icon-dimensions" alt="icon">
                </button>
            </div>
            <div class="modal-body py-0">
                <h1 class="modal-title sd-fs-45  sd-fw-500 lh-1 text-black pb-5">Filter By</h1>
                <form id="filterForm" method="post">
                    <div class="row align-items-baseline">
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="inpPatientName" class="form-label text-black sd-fw-600">Patient First Name</label>
                                <input id="inpPatientName" name="name" class="form-control border-1" data-msg-required="" maxlength="50" required="">
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="inpPatientLastName" class="form-label text-black sd-fw-600">Patient Last Name</label>
                                <input id="inpPatientLastName" name="lastname" class="form-control border-1" required="" maxlength="50">
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-baseline">
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="inpPhone" class="form-label text-black sd-fw-600">Phone Number</label>
                                <input id="inpPhone" name="phonenr" class="form-control border-1" type="tel" onchange="GetFullPhoneNumber('inpPhone', 'lblCountry1', 'lblCountryCode1', 'FullPhone1')" data-msg-required="" maxlength="10" required="">
                                <input type="hidden" name="country" id="lblCountry1">
                                <input type="hidden" name="FullPhoneNumber" id="FullPhone1">
                                <input type="hidden" name="CountryCode" id="lblCountryCode1">
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="inpEmail" class="form-label text-black sd-fw-600">Email</label>
                                <input id="inpEmail" name="email" class="form-control border-1" type="email" data-rule-email="" maxlength="100" required="">
                            </div>
                        </div>
                    </div>
                    <div class="row align-items-baseline">
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="SelectCountry" class="form-label text-black sd-fw-600">Nationality</label>
                                <select id="SelectCountry" class="border-1 form-select fs-6" dmx-class:text-gray-500="!SelectCountry.value" dmx-bind:options="json_countries.data.countries" optiontext="name" optionvalue="name" required="">
                                    <option value="">Select Country</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="mb-4">
                                <label for="inpDOB" class="form-label text-black sd-fw-600">Date of Birth</label>
                                <input id="inpDOB" name="dob" class="form-control border-1" type="text" is="dmx-date-picker" required="" data-msg-max="" dmx-bind:maxdate="dateNow.datetime">
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-6">
                        <div class="mb-4">
                            <label for="SelectGender" class="form-label text-black sd-fw-600">Gender</label>
                            <select id="SelectGender" class="border-1 form-select fs-6" dmx-class:text-gray-500="!SelectGender.value" required="">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                        </div>
                    </div>
                    <div class="border-divider mb-4"></div>

                    <div class="d-flex align-items-center my-4 justify-content-end">
                        <button id="clearFilters" type="button" class="btn btn-secondary text-primary sd-fw-600 mx-2 px-5 py-2" dmx-on:click="filterForm.reset();scPatients.load({},true);modalFilter.hide()">Clear Filters</button>
                        <button id="applyFilters" class="btn btn-primary text-white sd-fw-600 mx-2 px-5 py-2" dmx-on:click="scPatients.load({firstname: inpPatientName.value.lowercase(), lastname: inpPatientLastName.value.lowercase(), phone: inpPhone.value, email: inpEmail.value.lowercase(), nationality: SelectCountry.value, gender: SelectGender.value, dob: inpDOB.value});modalFilter.hide()">
                            Apply Filters</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAddPatient" is="dmx-bs5-modal" tabindex="-1" onshown="InitializeSelect2();" dmx-on:hide-bs-modal="formAddPatient.reset()">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content px-3 bg-gray-100 sd-radius-8 border-0">
            <div class="modal-header border-0 pb-0">
                <button type="button" class="bg-transparent border-0 ms-auto p-0 px-1" data-bs-dismiss="modal" aria-label="Close">
                    <img src="/assets/images/icons/Close.svg" class="sd-icon-dimensions" alt="icon">
                </button>
            </div>
            <div class="modal-body py-0">
                <h1 class="modal-title sd-fs-45  sd-fw-500 lh-1 text-black pb-5">
                    Add Patient
                </h1>
                <form id="formAddPatient" method="post" is="dmx-serverconnect-form" action="/api/Patients/addPatient" dmx-on:success="formAddPatient.reset();modalAddPatient.hide();scPatients.load({});notif.success(content.modalAddPatient.formAddPatient.data.exec.PatientName+' added successfully.')" dmx-on:forbidden="notif.warning(lastError.response)">
                    <div class="row">
                        <div class="col-12 col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" id="txtFirstName" class="form-control" name="firstname" placeholder="First Name" required="" maxlength="50">
                                <label for="txtName" class="text-gray-500">First Name *</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-3">
                            <div class="form-floating mb-3">
                                <input type="text" id="txtLastName" class="form-control" name="lastname" placeholder="Last Name" required="" maxlength="50">
                                <label for="txtName" class="text-gray-500">Last Name *</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="sd-phone-input mb-3">
                                <input type="text" id="txtPhone" class="form-control" placeholder="Phone" onchange="GetFullPhoneNumber('txtPhone', 'lblCountry', 'lblCountryCode', 'lblFullPhone')" name="phonenr" required="" maxlength="10">
                                <input type="hidden" name="country" id="lblCountry">
                                <input type="hidden" name="countrycode" id="lblCountryCode">
                                <input type="hidden" name="phone" id="lblFullPhone">
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="form-floating mb-3">
                                <input type="text" id="txtDOB" class="form-control" name="dateofbirth" placeholder="Date Of Birth" is="dmx-date-picker" dmx-bind:maxdate="dateNow.datetime">
                                <label for="txtDOB" class="text-gray-500">Date Of Birth</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="form-floating mb-3">
                                <input type="email" id="txtEmail" class="form-control" name="email" placeholder="name@example.com" dmx-bind:value="dataUser.data.Email">
                                <label for="txtName" class="text-gray-500">Email</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="txtSelectGender" name="gender" dmx-class:text-gray-500="!txtSelectGender.value">
                                    <option value="" selected disabled hidden>Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                                <label for="txtName" class="text-gray-500">Gender</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="txtSelectNationality" name="nationality" dmx-class:text-gray-500="!txtSelectNationality.value" dmx-bind:options="json_countries.data.countries" optiontext="name" optionvalue="name">
                                    <option value="">Select Country</option>
                                </select>
                                <label for="txtSelectNationality" class="text-gray-500">Nationality</label>
                            </div>
                        </div>
                        <div class="col-12 col-md-6">
                            <div class="form-floating mb-3">
                                <select class="form-select" id="txtSelectLang" name="langpreference" dmx-class:text-gray-500="!txtSelectLang.value">
                                    <option value="" selected disabled hidden>Select language</option>
                                    <option value="ar">Arabic</option>
                                    <option value="en">English</option>
                                </select>
                                <label for="txtName" class="text-gray-500">Language preference</label>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex my-4 pb-2 align-items-center justify-content-center justify-content-md-end">
                        <button id="btnCancelPatientModal" class="btn btn-secondary sd-fw-600 text-primary mx-2 px-3 px-md-5" data-bs-dismiss="modal">Cancel</button>
                        <button id="btnSaveUser" class="btn btn-primary sd-fw-600 text-white mx-2 px-3 px-md-5" type="submit" dmx-bind:disabled="state.executing">Add Patient
                            <span class="spinner-border spinner-border-sm ms-2" role="status" dmx-show="state.executing"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>